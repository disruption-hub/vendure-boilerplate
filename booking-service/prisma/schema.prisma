generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/booking-client"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(uuid())
  zkeyId         String   @unique
  email          String   @unique
  firstName      String?
  lastName       String?
  stripeCustomerId String?
  
  // Relations
  serviceProvider ServiceProvider?
  passes         Pass[]
  bookings       Booking[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum VenueType {
  SITE    // A physical building/address
  UNIT    // A business unit within a site (e.g. Yoga Studio)
  VIRTUAL // An online-only presence
}

enum NetworkType {
  COMPLEX    // Vertical grouping (The Building)
  NETWORK    // Horizontal grouping (The Franchise)
  FEDERATION // Ad-hoc partnership (Access sharing)
}

model Venue {
  id           String   @id @default(uuid())
  name         String
  description  String?
  address      String?
  timezone     String   @default("UTC")
  openingHours Json?    // Structure: { mon: { open: "09:00", close: "18:00" }, ... }
  amenities    Json?    // e.g. ["wifi", "parking", "lockers", "showers"]
  type         VenueType @default(UNIT)
  
  spaces       Space[]
  
  profileId    String?
  profile      BookingProfile? @relation(fields: [profileId], references: [id])

  // Hierarchy
  parentId     String?
  parent       Venue?    @relation("VenueHierarchy", fields: [parentId], references: [id])
  children     Venue[]   @relation("VenueHierarchy")

  // Horizontal Groups (Federations)
  networks     VenueNetwork[] @relation("VenueToNetwork")

  // Pass Validity
  validPasses  PassTemplate[] @relation("PassVenueValidity")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Space {
  id           String   @id @default(uuid())
  venueId      String
  venue        Venue    @relation(fields: [venueId], references: [id])
  
  name         String
  type         String   @default("room") // e.g. "yoga_studio", "cowork", "room"
  capacity     Int      @default(1)
  amenities    Json?    // e.g. ["yoga_mats", "projector"]
  
  sessions     Session[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SpacePreset {
  id           String   @id @default(uuid())
  name         String   // e.g. "Standard Yoga Studio"
  type         String   // e.g. "yoga_studio"
  capacity     Int      @default(1)
  amenities    Json?    // e.g. ["yoga_mats", "sound_system"]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ServiceProvider {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  
  bio          String?
  specialties  String[] // e.g. ["Yoga", "Therapy"]
  
  services     Service[]
  sessions     SessionProvider[]

  profileId    String?
  profile      BookingProfile? @relation(fields: [profileId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ServiceCategory {
  id           String   @id @default(uuid())
  name         String
  description  String?
  
  services     Service[]
  passTemplates PassTemplate[] @relation("PassTemplateCategories")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Service {
  id                  String   @id @default(uuid())
  name                String
  description         String?
  durationMinutes     Int      @default(60)
  bufferBeforeMinutes Int      @default(0)
  bufferAfterMinutes  Int      @default(0)
  defaultPrice        Decimal? @db.Decimal(10, 2)
  isOnline            Boolean  @default(false)
  
  categoryId          String?
  category            ServiceCategory? @relation(fields: [categoryId], references: [id])
  
  providerId          String? // Default provider if applicable
  provider            ServiceProvider? @relation(fields: [providerId], references: [id])
  
  sessions            Session[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Session {
  id              String   @id @default(uuid())
  
  // What is this session for?
  serviceId       String
  service         Service   @relation(fields: [serviceId], references: [id])
  
  // Where is it?
  spaceId         String?
  space           Space?    @relation(fields: [spaceId], references: [id])
  
  // Who is running it? (Can be multiple)
  providers       SessionProvider[]
  
  startTime       DateTime
  endTime         DateTime
  
  // Overrides
  maxCapacity     Int       // Defaults to Space validity or custom
  bufferOverride  Int?      // Overrides service buffer settings
  
  bookings        Booking[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model SessionProvider {
  sessionId       String
  session         Session         @relation(fields: [sessionId], references: [id])
  
  providerId      String
  provider        ServiceProvider @relation(fields: [providerId], references: [id])
  
  @@id([sessionId, providerId])
}

model PassTemplate {
  id                      String   @id @default(uuid())
  name                    String
  type                    PassType @default(PACK)
  
  // Linked Vendure Product
  vendureProductVariantId String?
  
  // Entitlements
  creditsAmount           Int?     // For PACK
  unlimited               Boolean  @default(false) // For MEMBERSHIP
  validDurationDays       Int?     // How long the pass is valid after purchase/activation
  
  // Restrictions
  validForCategories      ServiceCategory[] @relation("PassTemplateCategories")
  validForNetworks        VenueNetwork[]    @relation("PassNetworkValidity")
  validForVenues          Venue[]           @relation("PassVenueValidity")
  
  passes                  Pass[]
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

enum PassType {
  PACK
  MEMBERSHIP
}

model Pass {
  id               String       @id @default(uuid())
  
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  
  templateId       String
  template         PassTemplate @relation(fields: [templateId], references: [id])
  
  status           PassStatus   @default(ACTIVE)
  creditsRemaining Int?         // Decrements as used
  expiryDate       DateTime?
  
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

enum PassStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

model Booking {
  id        String        @id @default(uuid())
  
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  
  sessionId String
  session   Session       @relation(fields: [sessionId], references: [id])
  
  status    BookingStatus @default(CONFIRMED)
  
  checkedIn Boolean       @default(false)
  checkedInAt DateTime?
  
  cancellationReason String?
  isLateCancellation Boolean @default(false)
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  WAITLISTED
}

model BookingProfile {
  id           String   @id @default(uuid())
  slug         String   @unique // e.g. "yoga-studio", "hotel"
  name         String   // e.g. "Yoga Studio"
  description  String?
  
  // Configuration
  metrics      Json?    // Dashboard metrics config
  uiConfig     Json?    // UI branding/labels
  
  // Relations
  venues       Venue[]
  providers    ServiceProvider[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model VenueNetwork {
  id           String   @id @default(uuid())
  name         String
  description  String?
  type         NetworkType @default(NETWORK)
  
  venues       Venue[] @relation("VenueToNetwork")
  validPasses  PassTemplate[] @relation("PassNetworkValidity")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
